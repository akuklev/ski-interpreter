<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Simple Kombinator Interpreter</title>
    <link rel="shortcut icon" type="image/png" href="misc/ski-64.png">
    <script src="js/build/ski-interpreter.js"></script>
    <script src="misc/quests.js"></script>
    <link rel="stylesheet" href="misc/main.css">
</head>
<body>
<div class="all">
    <div class="layout" id="top">
        <div>
            <button id="mode-teletype" class="mode-pick" onclick="return modePick(this)">Workbook</button>
            <button id="mode-quest" class="mode-pick" onclick="return modePick(this)">Quests</button>
        </div>
    </div>
    <div class="layout main" id="main">
        <div class="pane" style="width: 69%">
            <div id="teletype" class="scroll">

            </div>
            <div id="quest" class="scroll hidden">

            </div>
        </div>

        <div id="info" class="pane" style="width: 29%;">
            <div><b>Known terms that can be used in expressions:</b></div>
            <ul id="known" class="scroll"></ul>
        </div>
    </div>
    <div class="layout" id="bottom">
        <form onsubmit="return toggleRun()">
            <div style="width: 99%"><input name="code" id="code" style="width:100%"></div>
            <div>
                <button class="bigcontrol" onclick="return insert('S')">S</button>
                <button class="bigcontrol" onclick="return insert('K')">K</button>
                <button class="bigcontrol" onclick="return insert('I')">I</button>
                <button class="bigcontrol" onclick="return insert('(')">(</button>
                <button class="bigcontrol" onclick="return insert(')')">)</button>
                <button class="bigcontrol" onclick="return toggleVerb()"><input type="checkbox" id="verbose" disabled="true">Verbose</button>
                <button class="bigcontrol" onclick="return toggleRun()" id="gostop">???</button>
            </div>
        </form>
        <div>
            &copy;2024 Konstantin Uvarin. <a href="https://github.com/dallaylaen/ski-interpreter" target="_blank">source code</a>
        </div>
    </div>
</div>

<script>
    /**
     *   References to static page elements
     */
    const view = {};
    for (const name of ['top', 'bottom', 'main', 'known', 'teletype', 'code', 'gostop', 'verbose'])
        view[name] = document.getElementById(name);
    const panels = {};
    for (const name of ['teletype', 'quest'])
        panels[name] = document.getElementById(name);

    /**
     *   Global state of the interpreter
     */

    let showlines = 10;
    let ski = new SKI;
    let count = 0;
    let running = false;

    init();

    /**
     * Page-specific functions
      */

    function init() {
        const greet = teletype();
        greet(
            'Welcome to the '+
            '<a href="https://en.wikipedia.org/wiki/SKI_combinator_calculus" target="_blank">' +
            'combinatory logic<a> interpreter.',
            {tag: 'p'}
        );
        greet(
            'Type an expression in the entry field and click "run!". ' +
            'A valid expression contains one or more terms and parenthesis around groups of terms. ' +
            'Unknown terms will be left as is. ',
            {tap: 'p'}
        );
        greet(
            'New terms can be declared by prepending <code>"name&nbsp;=&nbsp;"</code> to the expression. ' +
            'They will appear in the box on the right and can be clicked to add them to the expression',
            {tag: 'p'}
        );
        greet(
            "Your output goes here. ",
            {color: "green"}
        );
        resetGo();
        showKnown();
        view.verbose.checked = false;
        view.code.addEventListener('keydown', onKey);
        window.addEventListener('resize', onResize);
        onResize();

        const params = getParams();
        if (params.code) {
            view.code.value = params.code;
        } else if (!view.code.value.match(/\S/))
            view.code.value = 'S K I x';

        if (params.terms) {
            for (let pair of params.terms.split(',')) {
                const [name, impl] = pair.split(':');
                ski.add(name, impl);
            }
            showKnown();
        }

        for (const spec of getQuests())
            makeQuest(spec);
    }

    function onKey (event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            if (!running)
                toggleRun();
            return false;
        }
        return true;
    }

    function onResize() {
        // FIXME should be done via css instead...
        const height = window.innerHeight - view.top.offsetHeight - view.bottom.offsetHeight;

        view.main.style.height = height + 'px';
        return true;
    }

    function toggleVerb () {
        view.verbose.checked = !view.verbose.checked;
        showlines = view.verbose.checked ? Infinity : 10;
        return false;
    }

    // page functions
    function toggleRun() {
        if (running) {
            running = false;
        } else {
            view.gostop.innerHTML = "Stop!";
            running = true;
            run();
        }
        return false;
    }

    function modePick (item) {
        const [_, name] = item.id.match(/^mode-(\w+)$/);
        for (const id in panels)
            showhide(panels[id], name === id);
    }

    /**
     *
     * @param {Array} spec
     */
    function makeQuest (spec) {
        const quest = new SKI.Quest(...spec);

        const frame = append(panels.quest, 'div', {class: ['quest']});
        append(frame, 'div', {content: quest.title, class: ['con-header']});
        if (quest.descr)
            append(frame, 'div', {content: quest.descr, class:['note']});

        const box = append(frame, 'div', {class: ['quest-content']});
        for (let test of quest.show()) {
            const row = append(box, 'div');
            append(row, 'span', {content: '? '});
            append(row, 'span', {content: '&lt;your code&gt; '+test.args.join(' ')});
        }

        const btn = append(frame, 'button', {content: 'verify'});
        btn.onclick = () => checkQuest(box, quest, ski.parse(view.code.value));
    }

    /**
     *
     * @param {Element} output
     * @param {Quest} quest
     * @param {Ast} expr
     */
    function checkQuest (output, quest, expr) {
        output.innerHTML = 'running...';
        const report = quest.check(expr);
        output.innerHTML = '';
        for (const item of report.details) {
            const line = append(output, 'div', {class: item.pass ? ['success'] : ['error']});
            append(line, 'span', {content: item.pass ? '&check;' : '&cross;'});
            append(line, 'span', {content: expr + ' ' + item.args.join(' ')});
            if (item.pass) {
                append(line, 'span', {content: ' == '+item.found});
            } else {
                append(line, 'br');
                append(line, 'span', {content: 'found: '+item.found});
                append(line, 'br');
                append(line, 'span', {content: 'expected '+item.expected});
            }
        }
    }

    function run() {
        const out = teletype();

        const maybeAssign = view.code.value.match(/^\s*([a-z][a-z_0-9]*)\s*=\s*(.*)$/i);
        const src = maybeAssign ? maybeAssign[2] : view.code.value;
        const saveAs = maybeAssign ? maybeAssign[1] : undefined;

        const head = out( '<a href="'+permalink(view.code.value)+'" target="_blank"><b>Expression #'+(++count)+'</b></a>',
            {tag: 'div', nobr: true, class: 'con-header'});
        append(head, 'span').innerHTML = '  steps: ';
        const iterfield = append(head, 'span');
        iterfield.innerHTML = '-';

        const tick = getRunner(out, iterfield);

        try {
            let expr = ski.parse(src);
            if (saveAs) {
                ski.add(saveAs, expr);
                showKnown();
            }
            tick(expr);
        } catch (err) {
            out(err, {class: 'error'});
            resetGo();
        }
    }

    function getRunner(out, iterfield) {
        let step = 0;
        let line;
        const tick = expr => {
            // check interrupt
            if (!running) {
                out ("...interrupted!", {class: "error"});
                resetGo();
                return;
            }

            // output state
            step++;
            if (!line || step <= showlines)
                line = out('');
            line.rewrite(expr);
            iterfield.innerHTML = ''+step;

            // calculate & setup next iteration
            const next = expr.step();
            if (next) {
                setTimeout(() => tick(next), 0);
            } else {
                out('&check;', {class: 'success'});
                resetGo();
            }
        };
        return tick;
    }

    function resetGo () {
        running = false;
        view.gostop.innerHTML = "Run!";
    }

    function showKnown() {
        view.known.innerHTML = '';
        const list = ski.getTerms();
        for (let name of Object.keys(list).sort()) {
            const entry = list[name];
            const li = append(view.known, 'li');
            const out = append(li, 'a', {class: ['note', 'clickable']});
            out.href = '#';
            out.onclick = event => insert(name);
            append(out, 'b').innerHTML = name;
            append(out, 'span').innerHTML = " ";
            if (entry.note)
                append(out, 'i').innerHTML = entry.note;
            else
                append(out, 'tt').innerHTML = '= '+entry.impl;
        }
    }

    function insert (text) {
        const orig = view.code.value;
        const prefix = orig.substring(0,  view.code.selectionStart);
        const postfix = orig.substring(view.code.selectionEnd);

        // add spaces around if we're not an elementary term
        if (!text.match(/^[()A-Z]$/))
            text = (prefix.match(/(?:^| )$/) ? '' : ' ') + text + (postfix.match(/^(?: |$)/) ? '' : ' ');

        view.code.value = prefix + text + postfix;
        view.code.selectionStart = prefix.length + text.length;
        view.code.selectionEnd   = prefix.length + text.length;

        return false;
    }

    function permalink(sample) {
        const terms = ski.getTerms();
        const saved = Object.keys(terms)
            .filter(name => !terms[name].isNative())
            .map(name => name+':'+terms[name].expand()).join(',');
        return '?code=' + encode(sample) + '&terms=' + encode(saved);
    }

    /**
     * create a function that takes test and appends it to specific region
     * in a specific <div>
     * @param {Object} opt
     * @return {(function(string, Object?): void)}
     */
    function teletype(opt={}) {
        const sheet = append(view.teletype, opt.tag ?? 'div');
        if (opt.color)
            sheet.style.color = opt.color;
        sheet.style.border = 'dotted 1px '+(opt.color ?? 'black');
        return function (text, opt={}) {
            const line = append(sheet, opt.tag ?? 'span');
            if (opt.color)
                line.style.color = opt.color;
            if (opt.bgcolor)
                line.style.background = opt.bgcolor;
            if (opt.padding)
                line.style.paddingLeft = line.style.paddingRight = opt.padding+"em";
            if (opt.class)
                line.classList.add(opt.class);
            line.rewrite = function(str) {
                this.innerHTML = ''+str;
                view.teletype.scrollTop = line.offsetTop;
                return this;
            }
            line.rewrite(text);
            if (!opt.nobr)
                append( sheet, 'br' );
            return line;
        }
    }

    /**
     *   HTML-related utility functions
     */

    /**
     *
     * @param parent
     * @param type
     * @return {HTMLElement}
     */
    function append(parent, type, options={}) {
        const child = document.createElement(type);
        if (options.class)
            child.classList.add(...options.class);
        if (options.content !== undefined)
            child.innerHTML = '' + options.content;
        parent.appendChild(child);
        return child;
    }

    /**
     *
     * @param {Element} element
     * @param {boolean} visible
     */
    function showhide(element, visible=false) {
        if (visible)
            element.classList.remove('hidden');
        else
            element.classList.add('hidden');
    }

    function getParams() {
        // Somewhat ad hoc but it's javascript ^_^
        const raw = window.location.search.substring(1) || '';
        const out = {};
        raw.split('&').forEach( pair => {
            const [ name, value ] = pair.split('=');
            if (value === undefined) return; // TODO die
            out[name] = decode(value);
        })
        return out;
    }

    function encode (s) {
        // FB and possibly others don't recognize '(' and ')' in URLs,
        // so have to encode these chars correctly
        const parens = {
            '(': '%28',
            ')': '%29',
        }
        return encodeURIComponent(s).replace(/[()]/g, c => parens[c]);
    }
    function decode (s) {
        return decodeURIComponent((''+s).replace(/\+/g, ' '));
    }

</script>
</body>
</html>
