<html>
<head>
    <meta charset="utf-8"/>
    <title>SKI combinatory logic interpreter</title>
    <link rel="shortcut icon" type="image/gif" href="favicon.ico">
    <script src="js/build/ski-interpreter.js"></script>
</head>
<body>
    <h1>SKI combinatory logic interpreter</h1>

    Edit code below, then press Run!
    <div id="cons" style="height: 10em; overflow:scroll; resize:vertical"></div>

    <input name="code" id="code">
    <button onclick="return run()" style="background-color: lime">Run!</button>
<script>
    function out(text, opt={}) {
        const canvas = document.createElement(opt.tag || 'pre');
        canvas.style.color = opt.color || 'black';
        canvas.style.border = 'dotted 1px '+(opt.color || 'black');
        const container = document.getElementById('cons');
        container.appendChild(canvas);
        canvas.innerHTML = text; // TODO insecure
        container.scrollTop = canvas.offsetTop;
    };

    const code = document.getElementById('code');
    const href = window.location.href.replace( /\?.*$/, '' );

    function run() {
        const src = code.value;
        const link = href+'?code='+encodeURIComponent(src);
        out( '<a href="'+link+'" target="_blank">'
            +'code sample permalink</a>', { tag: 'div' } );
        new Promise( done => {
            const ski = new SKI;
            let expr = ski.parse(src);

            // TODO do it via promise so that it's stoppable
            do {
                const next = expr.step();
                out(''+expr);
                expr = next;
            } while (expr);

            done( );
        })
            .then(  _   => out("<br>---</br>"))
            .catch( err => out(err, {color: 'red'}));
    }

    function getParams() {
        // Somewhat ad hoc but it's javascript ^_^
        const raw = window.location.search.substr(1) || '';
        const out = {};
        raw.split('&').forEach( pair => {
            const [ name, value ] = pair.split('=');
            if (value === undefined) return; // TODO die
            out[name] = decodeURIComponent(value);
        })
        return out;
    }

    // TODO also store code in localstorage
    const init = getParams().code;
    if (init) {
        code.value = init;
    } else if (!code.value.match(/\S/))
        code.value = 'S K I x';

    out(
        "Your output goes here. "
        +"Use <code>out(text, { color: color });</code> to display data if needed.",
        { color: "green", tag: 'span' }
    );
</script>
</body>
</html>
