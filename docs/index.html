<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Simple Kombinator Interpreter</title>
    <link rel="shortcut icon" type="image/png" href="misc/ski-64.png">
    <script src="js/build/ski-interpreter.js"></script>
    <link rel="stylesheet" href="misc/main.css">
</head>
<body>
    <h1>Simple Kombinator Interpreter</h1>

    <div id="cons" style="height: 20em; overflow:scroll; resize:vertical; font-family: monospace"></div>

    <div>
        <form onsubmit="return toggleRun()">
        <div stype="flex"><input name="code" id="code" style="width:100%"></div>
        <button onclick="return toggleRun()" id="gostop" style="background-color: lime">???</button>
        </form>
    </div>

    <div id="help">
        <p>
            Welcome to the
            <a href="https://en.wikipedia.org/wiki/Combinatory_logic" target="_blank">combinatory logic<a>
            interpreter.
        </p>
        <p>
            Type an expression in the above entry field and click "run!".
            A valid expression contains one or more terms and parenthesis around groups of terms.
            Unknown terms will be left as is.
            New terms can be declared by prepending <tt>"name&nbsp;=&nbsp;"</tt> to the expression.
        </p>
        <p>Known combinators that can be used in expressions:</p>
        <ul id="known">

        </ul>
    </div>
<script>
    const cons = document.getElementById('cons');

    function teletype(opt={}) {
        const sheet = append(cons, opt.tag ?? 'div');
        sheet.style.color = opt.color ?? 'black';
        sheet.style.border = 'dotted 1px '+(opt.color || 'black');
        return function (text, opt={}) {
            const line = append(sheet, opt.tag ?? 'span');
            if (opt.color)
                line.style.color = opt.color;
            if (opt.bgcolor)
                line.style.background = opt.bgcolor;
            if (opt.padding)
                line.style.paddingLeft = line.style.paddingRight = opt.padding+"em";
            line.innerHTML = text;
            if (!opt.nobr)
                append( sheet, 'br' );
            cons.scrollTop = line.offsetTop;
        }
    }



    const code = document.getElementById('code');
    const href = window.location.href.replace( /\?.*$/, '' );
    const gostop = document.getElementById('gostop');

    let count = 0;
    let running;

    function toggleRun() {
        if (running) {
            running = false;
        } else {
            gostop.innerHTML = "Stop!";
            running = true;
            run();
        }
        return false;
    }

    // global state to keep declared vars declared
    let ski = new SKI;

    function run() {
        const out = teletype();

        const maybeAssign = code.value.match(/^\s*([a-z][a-z_0-9]*)\s*=\s*(.*)$/i);
        const src = maybeAssign ? maybeAssign[2] : code.value;
        const saveAs = maybeAssign ? maybeAssign[1] : undefined;

        const link = href+'?code='+encode(src);
        out( ++count, {nobr: true, color: 'white', bgcolor: 'blue', padding: 1})
        out( '<a href="'+link+'" target="_blank">'+'code sample permalink</a>',
            {padding: 1});

        const tick = expr => {
            out(''+expr);
            if (!running) {
                out ("...interrupted!", {color: "red"});
                resetGo();
                return;
            }

            const next = expr.step();
            if (next) {
                setTimeout(() => tick(next), 0);
            } else {
                out('&nbsp;&nbsp;', {bgcolor: 'black'});
                resetGo();
            }
        };

        try {
            let expr = ski.parse(src);
            if (saveAs) {
                ski.add(saveAs, expr);
                showKnown();
            }
            tick(expr);
        } catch (err) {
            out(err, {color: 'red'});
            resetGo();
        }
    }

    function resetGo () {
        running = false;
        gostop.innerHTML = "Run!";
    }

    function getParams() {
        // Somewhat ad hoc but it's javascript ^_^
        const raw = window.location.search.substr(1) || '';
        const out = {};
        raw.split('&').forEach( pair => {
            const [ name, value ] = pair.split('=');
            if (value === undefined) return; // TODO die
            out[name] = decodeURIComponent(value);
        })
        return out;
    }

    // TODO also store code in localstorage
    const init = getParams().code;
    if (init) {
        code.value = init;
    } else if (!code.value.match(/\S/))
        code.value = 'S K I x';


    const listKnown = document.getElementById("known");
    function showKnown() {
        listKnown.innerHTML = '';
        const list = ski.list();
        for (let name of Object.keys(list).sort()) {
            const entry = list[name];
            const out = append(listKnown, 'li');
            out.classList.add('note');
            append(out, 'b').innerHTML = name;
            append(out, 'span').innerHTML = " ";
            if (entry.note)
                append(out, 'i').innerHTML = entry.note;
            else
                append(out, 'tt').innerHTML = entry.impl;
        }
    }

    /**
     *
     * @param parent
     * @param type
     * @return {HTMLElement}
     */
    function append(parent, type) {
        const child = document.createElement(type);
        parent.appendChild(child);
        return child;
    }

    function encode (s) {
        // FB and possibly others don't recognize '(' and ')' in URLs,
        // so have to encode these chars correctly
        const parens = {
            '(': '%28',
            ')': '%29',
        }
        return encodeURIComponent(s).replace(/[()]/g, c => parens[c]);
    }

    teletype()(
        "Your output goes here. ",
        { color: "green" }
    );
    teletype()(
        ['i', 'k', 's'].map (sym => '<img src="3rd-party/img/card_'+sym+'.png">').join('&nbsp;')
    )
    resetGo();
    showKnown();
</script>
</body>
</html>
