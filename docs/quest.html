<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Quests - Simple Kombinator Interpreter</title>
    <link rel="shortcut icon" type="image/png" href="img/ski-64.png">
    <script src="build/js/ski-interpreter.js"></script>
    <script src="js/util.js"></script>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
<div class="layout" id="top">
    <h1>Simple Kombinator Interpreter quest mode</h1>
    <a href="index.html" target="_blank">free form SKI interpreter</a>
</div>
<div class="layout" id="main">
    <div class="pane" id="quest" style="width: 69%"></div>
    <div class="pane">
        <p>The combinators: </p>
        <ul>
            <li><b>I</b>, the identity: <code>x -> x</code></li>
            <li><b>K</b>, the constant: <code>x y -> x</code></li>
            <li><b>S</b>, the substitution: <code>x y z -> x z (y z)</code></li>

        </ul>
    </div>
</div>
<div class="layout" id="bottom">
    <div>
        &copy;2024 Konstantin Uvarin. <a href="https://github.com/dallaylaen/ski-interpreter" target="_blank">source code</a>
    </div>
</div>
<script>
    const view = grabView('quest');
    const questDir = 'quest-data/';

    init();

    function init() {
        rubberDesign('main');

        fetch(questDir + 'index.json')
            .then( resp => resp.json())
            .then( list => {
                let chap = 1;
                for (const item of list) {
                    makeChapter(item, chap++);
                }
            });
    }

    function makeChapter (opt, n) {
        const container = append(view.quest, 'div', {class: ['chapter']});
        const title = append(container, 'div', {class: ['title'], content: opt.name});
        const stats = append(title, 'span', {class: ['float-right']});
        const counter = append( stats, 'span', {content: '0'});
        let solved = 0;

        append(container, 'div', {class: ['note'], content: cat(opt.intro)});
        const inner = append(container, 'div', {});
        fetch(questDir + opt.link)
            .then( resp => resp.json() )
            .then( list => {
                let k = 0;
                for (const item of list) {
                    makeQuest(inner, item, n + '.' + ++k, () => { counter.innerHTML = '' + ++solved });
                }
                append(stats, 'span', {content: '/'+k});
            });
    }

    /**
     * @param {Element} container
     * @param {Array} spec
     * @param {string} n
     * @param {Function} onComplete
     * @return {void}
     */

    function makeQuest (container, spec, n, onComplete = x => x) {
        const quest = new SKI.Quest(...spec);
        const frame = append(container, 'div', {class: ['quest-box']});

        const name = 'quest-'+n;
        const title = append(frame, 'div', {class: ['con-header']});
        append (title, 'a').name = name;
        const expand = append(title, 'a', {content: n ? '#' + n + ' ' : 'Quest'});
        append(title, 'span', {content: quest.title});
        expand.href = '#'+name;

        const body = append(frame, 'div');
        expand.onclick = () => showhide(body, true);

        const descr = append(body, 'div', {content: cat(quest.descr), class:['note']});
        if (quest.meta.hint)
            hint(descr, ' Hint:...', ' Hint: '+quest.meta.hint);

        const box = append(body, 'div', {class: ['quest-content'], content: '....'});

        const form = append(body, 'div', {class: ['quest-solve']});
        const input = append(form, 'input');
        const btn = append(form, 'button', {content: 'solve!'});
        const moveOn = append(form, 'button', {content: 'move on >>', class: ['hidden']});
        moveOn.onclick = () => showhide(body, false);

        const summary = append(append(title, 'span', {class: ['float-right']}), 'i');
        let solved = false;
        let count = 0;
        let attempts = 0;
        const sumUpdate = report => {
            if (solved)
                return;
            if (report.pass) {
                solved = true;
                summary.classList.add('success');
                onComplete();
            }

            attempts++;
            for (const item of report.details)
                count += item.count;

            summary.innerHTML = 'Attempts: '+attempts+', total steps: '+count;
        }

        const runme = () => checkQuest(box, quest, input.value,
            function (report) {
                showhide(moveOn, true);
                sumUpdate(report);
            },
            function (report) {
                sumUpdate(report);
            }
        );
        btn.onclick = runme;
        input.onkeydown = (ev => ev.key === "Enter" ? runme() : true);
    }

    /**
     *
     * @param {Element} output
     * @param {Quest} quest
     * @param {Ast} expr
     * @param {function} [onpass]
     * @param {function} [onfail]
     */
    function checkQuest (output, quest, expr, onpass, onfail) {
        output.innerHTML = 'running...';
        const report = quest.check(expr);
        output.innerHTML = '';
        if (report.exception) {
            append(output, 'div', {class: ['error'], content: 'Execution failed: '+report.exception});
        }
        for (const item of report.details) {
            const line = append(output, 'div', {class: item.pass ? ['success'] : ['error']});
            append(line, 'span', {content: item.pass ? '&check;' : '&cross;'});
            append(line, 'span', {content: expr + ' ' + item.args.join(' ')});
            if (item.pass) {
                append(line, 'span', {content: ' == '+item.found+' in '+item.count+' iterations'});
            } else {
                append(line, 'br');
                append(line, 'span', {content: 'found: '+item.found});
                append(line, 'br');
                append(line, 'span', {content: 'expected '+item.expected});
            }
        }
        const action = report.pass ? onpass : onfail;
        if (action)
            action(report);
        return false;
    }

    function cat(input) {
        if (Array.isArray(input))
            return input.join(' ');
        else
            return ''+input;
    }

    function hint (element, shown, hidden) {
        const container = append(element, 'span', {});
        const clickme = append(container, 'span', {content: shown, class: ['hint']});
        clickme.onclick = () => {
            clickme.remove();
            append(container, 'span', { content: hidden });
        };
    }
</script>
</body>
</html>
